<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุงุฑ ุญุณุงุจุงุช ุงูููุฎุต ูุงูุฌุฏุงูู</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div style="padding: 20px;">
        <h1>ุงุฎุชุจุงุฑ ุญุณุงุจุงุช ุงูููุฎุต ูุงูุฌุฏุงูู</h1>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>1. ุฅุนุฏุงุฏ ุจูุงูุงุช ูุชููุนุฉ ููุงุฎุชุจุงุฑ</h2>
            <button class="btn btn-primary" onclick="setupComplexTestData()">ุฅุนุฏุงุฏ ุจูุงูุงุช ูุชุนุฏุฏุฉ</button>
            <button class="btn btn-success" onclick="viewDashboard()">ุนุฑุถ ููุญุฉ ุงูุชุญูู</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>2. ุงุฎุชุจุงุฑ ุฌุฏูู ุงูุทูุงุจ</h2>
            <button class="btn btn-info" onclick="testDataGridView()">ูุญุต ุฌุฏูู ุงูุทูุงุจ</button>
            <button class="btn btn-warning" onclick="testStudentManagement()">ุงุฎุชุจุงุฑ ุฅุฏุงุฑุฉ ุงูุทุงูุจ</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>3. ุงุฎุชุจุงุฑ ุนูููุงุช ุงูุฏูุน ูุงูุชุญุฏูุซ</h2>
            <button class="btn btn-success" onclick="simulatePayments()">ูุญุงูุงุฉ ุฏูุนุงุช</button>
            <button class="btn btn-secondary" onclick="verifyCalculations()">ุงูุชุญูู ูู ุงูุญุณุงุจุงุช</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>4. ููุญุฉ ุงูุชุญูู ุงููุญุฏุซุฉ</h2>
            <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="stat-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: #4c51bf; color: white; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h3 id="test-total-students" style="margin: 0; color: #4c51bf;">0</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">ุฅุฌูุงูู ุงูุทูุงุจ</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: #48bb78; color: white; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div>
                            <h3 id="test-total-fees" style="margin: 0; color: #48bb78;">0.000 ุฑ.ุน</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">ุฅุฌูุงูู ุงูุฑุณูู</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: #38a169; color: white; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h3 id="test-paid-fees" style="margin: 0; color: #38a169;">0.000 ุฑ.ุน</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">ุงููุจุงูุบ ุงููุณุฏุฏุฉ</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: #ed8936; color: white; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h3 id="test-pending-fees" style="margin: 0; color: #ed8936;">0.000 ุฑ.ุน</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">ุงููุจุงูุบ ุงููุชุจููุฉ</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: #e53e3e; color: white; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h3 id="test-overdue-fees" style="margin: 0; color: #e53e3e;">0.000 ุฑ.ุน</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">ุงููุชุฃุฎุฑุงุช (<span id="test-overdue-students">0</span> ุทุงูุจ)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>5. ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงูุชูุตูููุฉ</h2>
            <div id="test-results" style="min-height: 400px; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; overflow-y: auto;">
                ุงููุฑ ุนูู "ุฅุนุฏุงุฏ ุจูุงูุงุช ูุชุนุฏุฏุฉ" ูุจุฏุก ุงูุงุฎุชุจุงุฑ...
            </div>
        </div>
        
        <!-- ุงูููุงูุฐ ุงูููุจุซูุฉ -->
        <div id="alert-overlay" class="alert-overlay">
            <div class="alert-box">
                <div class="alert-icon">
                    <i id="alert-icon" class="fas fa-info-circle"></i>
                </div>
                <div class="alert-content">
                    <p id="alert-message"></p>
                </div>
                <div class="alert-actions">
                    <button class="btn btn-primary" onclick="closeAlert()">ุญุณูุงู</button>
                </div>
            </div>
        </div>
    </div>

    <script src="database.js"></script>
    <script src="app.js"></script>
    
    <script>
        let testStudents = [];
        
        function setupComplexTestData() {
            // ุชุณุฌูู ุฏุฎูู ุชููุงุฆู
            const adminUser = {
                id: 1,
                username: 'admin',
                role: 'admin',
                name: 'ูุฏูุฑ ุงููุธุงู'
            };
            localStorage.setItem('logged_in_user', JSON.stringify(adminUser));
            
            // ุฅูุดุงุก ุทูุงุจ ูุชููุนูู
            const studentsToCreate = [
                {
                    name: 'ุฃุญูุฏ ูุญูุฏ ุนูู',
                    grade: 'ุงูุตู ุงูุฎุงูุณ',
                    guardian_type: 'ููุธู',
                    employee_name: 'ูุญูุฏ ุนูู ุงูููุฏู',
                    phone: '96891234567',
                    current_fees: 600,
                    installments_count: 3,
                    first_installment_date: '2024-01-01', // ูุชุฃุฎุฑุงุช
                    advance_payment: 0
                },
                {
                    name: 'ูุงุทูุฉ ุณุงูู ุฃุญูุฏ',
                    grade: 'ุงูุตู ุงูุซุงูุซ',
                    guardian_type: 'ุบูุฑ ููุธู',
                    phone: '96891234568',
                    current_fees: 450,
                    installments_count: 2,
                    first_installment_date: '2024-02-01', // ูุชุฃุฎุฑุงุช ุฌุฒุฆูุฉ
                    advance_payment: 100
                },
                {
                    name: 'ุนุจุฏุงููู ุฎุงูุฏ ุณุนูุฏ',
                    grade: 'ุงูุตู ุงูุฃูู',
                    guardian_type: 'ููุธู',
                    employee_name: 'ุฎุงูุฏ ุณุนูุฏ ุงูุจููุดู',
                    phone: '96891234569',
                    current_fees: 400,
                    installments_count: 4,
                    first_installment_date: '2024-03-01', // ุญุฏูุซ
                    advance_payment: 50
                }
            ];
            
            testStudents = [];
            addLog('ุจุฏุก ุฅูุดุงุก ุจูุงูุงุช ุงูุทูุงุจ ุงููุชููุนุฉ...');
            
            studentsToCreate.forEach((studentInfo, index) => {
                const studentData = {
                    academic_year: '2024-2025',
                    name: studentInfo.name,
                    grade: studentInfo.grade,
                    guardian_type: studentInfo.guardian_type,
                    employee_name: studentInfo.employee_name,
                    phone: studentInfo.phone,
                    current_fees: studentInfo.current_fees,
                    installments_count: studentInfo.installments_count,
                    first_installment_date: studentInfo.first_installment_date,
                    advance_payment: studentInfo.advance_payment,
                    payment_method: 'ููุฏุงู'
                };
                
                const result = db.addStudent(studentData);
                
                if (result.success) {
                    testStudents.push(result.student);
                    addLog(`โ ุชู ุฅูุดุงุก ุงูุทุงูุจ ${index + 1}: ${result.student.name} (ID: ${result.student.id})`);
                } else {
                    addLog(`โ ูุดู ูู ุฅูุดุงุก ุงูุทุงูุจ ${index + 1}: ${result.error}`);
                }
            });
            
            addLog(`ุชู ุฅูุดุงุก ${testStudents.length} ุทุงูุจ ูู ุฃุตู ${studentsToCreate.length}`);
            addLog('==========================================');
        }
        
        function viewDashboard() {
            addLog('ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู...');
            
            const stats = db.getDashboardStats();
            
            // ุชุญุฏูุซ ุงูุจุทุงูุงุช ุงูุชุฌุฑูุจูุฉ
            document.getElementById('test-total-students').textContent = stats.totalStudents;
            document.getElementById('test-total-fees').textContent = formatCurrency(stats.totalFees);
            document.getElementById('test-paid-fees').textContent = formatCurrency(stats.totalPaid);
            document.getElementById('test-pending-fees').textContent = formatCurrency(stats.totalPending);
            document.getElementById('test-overdue-fees').textContent = formatCurrency(stats.totalOverdue || 0);
            document.getElementById('test-overdue-students').textContent = stats.studentsWithOverdue || 0;
            
            addLog('ุฅุญุตุงุฆูุงุช ููุญุฉ ุงูุชุญูู:');
            addLog(`- ุฅุฌูุงูู ุงูุทูุงุจ: ${stats.totalStudents}`);
            addLog(`- ุฅุฌูุงูู ุงูุฑุณูู: ${formatCurrency(stats.totalFees)}`);
            addLog(`- ุงููุจุงูุบ ุงููุณุฏุฏุฉ: ${formatCurrency(stats.totalPaid)}`);
            addLog(`- ุงููุจุงูุบ ุงููุชุจููุฉ: ${formatCurrency(stats.totalPending)}`);
            addLog(`- ุงููุชุฃุฎุฑุงุช: ${formatCurrency(stats.totalOverdue || 0)}`);
            addLog(`- ุงูุทูุงุจ ุงููุชุฃุฎุฑูู: ${stats.studentsWithOverdue || 0}`);
            addLog('==========================================');
        }
        
        function testDataGridView() {
            addLog('ูุญุต ุจูุงูุงุช ุฌุฏูู ุงูุทูุงุจ...');
            
            if (testStudents.length === 0) {
                addLog('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ุทูุงุจ. ูู ุจุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุฃููุงู');
                return;
            }
            
            testStudents.forEach((student, index) => {
                const fees = db.getStudentFees(student.id);
                const payments = db.getStudentPayments(student.id);
                const stats = calculateStudentStats(student, fees, payments);
                
                addLog(`ุงูุทุงูุจ ${index + 1}: ${student.name}`);
                addLog(`  - ุฅุฌูุงูู ุงูุฑุณูู: ${formatCurrency(stats.totalFees)}`);
                addLog(`  - ุงููุจูุบ ุงููุณุฏุฏ: ${formatCurrency(stats.totalPaid)}`);
                addLog(`  - ุงููุจูุบ ุงููุชุจูู: ${formatCurrency(stats.remainingAmount)}`);
                addLog(`  - ุงููุชุฃุฎุฑุงุช: ${formatCurrency(stats.overdueAmount)}`);
                addLog(`  - ูุณุจุฉ ุงูุชูุฏู: ${stats.progressPercentage}%`);
                addLog('');
            });
            
            addLog('==========================================');
        }
        
        function testStudentManagement() {
            if (testStudents.length === 0) {
                addLog('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ุทูุงุจ. ูู ุจุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุฃููุงู');
                return;
            }
            
            const firstStudent = testStudents[0];
            addLog(`ูุชุญ ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ: ${firstStudent.name}`);
            
            try {
                manageStudent(firstStudent.id);
                addLog('โ ุชู ูุชุญ ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ ุจูุฌุงุญ');
                
                // ูุญุต ุชุญุฏูุซ ุงููุนูููุงุช
                setTimeout(() => {
                    const feesElement = document.getElementById('manage-total-fees');
                    if (feesElement) {
                        addLog(`โ ุงููุจูุบ ุงููุชุจูู ูู ุงูุฑุฃุณ: ${feesElement.textContent}`);
                    }
                    
                    // ุฅุบูุงู ุงููุงูุฐุฉ
                    const modal = document.getElementById('manage-student-modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }, 1000);
                
            } catch (error) {
                addLog(`โ ุฎุทุฃ ูู ูุชุญ ุดุงุดุฉ ุงูุฅุฏุงุฑุฉ: ${error.message}`);
            }
        }
        
        function simulatePayments() {
            if (testStudents.length === 0) {
                addLog('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ุทูุงุจ. ูู ุจุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุฃููุงู');
                return;
            }
            
            addLog('ูุญุงูุงุฉ ุฏูุนุงุช ููุทูุงุจ...');
            
            // ุฏูุนุฉ ููุทุงูุจ ุงูุฃูู
            const payment1 = {
                student_id: testStudents[0].id,
                amount: 200,
                payment_method: 'ููุฏุงู',
                payment_date: new Date().toISOString().split('T')[0],
                notes: 'ุฏูุนุฉ ุชุฌุฑูุจูุฉ 1'
            };
            
            const result1 = db.addPayment(payment1);
            if (result1.success) {
                addLog(`โ ุชู ุฏูุน ${formatCurrency(200)} ููุทุงูุจ ุงูุฃูู`);
            }
            
            // ุฏูุนุฉ ููุทุงูุจ ุงูุซุงูู
            const payment2 = {
                student_id: testStudents[1].id,
                amount: 150,
                payment_method: 'ุจูู',
                payment_date: new Date().toISOString().split('T')[0],
                notes: 'ุฏูุนุฉ ุชุฌุฑูุจูุฉ 2'
            };
            
            const result2 = db.addPayment(payment2);
            if (result2.success) {
                addLog(`โ ุชู ุฏูุน ${formatCurrency(150)} ููุทุงูุจ ุงูุซุงูู`);
            }
            
            addLog('ุชู ุงูุงูุชูุงุก ูู ูุญุงูุงุฉ ุงูุฏูุนุงุช');
            addLog('==========================================');
        }
        
        function verifyCalculations() {
            addLog('ุงูุชุญูู ูู ุตุญุฉ ุงูุญุณุงุจุงุช...');
            
            const stats = db.getDashboardStats();
            let manualTotal = 0;
            let manualPaid = 0;
            
            testStudents.forEach(student => {
                const fees = db.getStudentFees(student.id);
                const payments = db.getStudentPayments(student.id);
                const studentStats = calculateStudentStats(student, fees, payments);
                
                manualTotal += studentStats.totalFees;
                manualPaid += studentStats.totalPaid;
            });
            
            const manualRemaining = manualTotal - manualPaid;
            
            addLog('ููุงุฑูุฉ ุงูุญุณุงุจุงุช:');
            addLog(`ุฅุฌูุงูู ุงูุฑุณูู - ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${formatCurrency(stats.totalFees)}`);
            addLog(`ุฅุฌูุงูู ุงูุฑุณูู - ุญุณุงุจ ูุฏูู: ${formatCurrency(manualTotal)}`);
            addLog(`ุงููุทุงุจูุฉ: ${stats.totalFees === manualTotal ? 'โ' : 'โ'}`);
            addLog('');
            addLog(`ุงููุจุงูุบ ุงููุณุฏุฏุฉ - ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${formatCurrency(stats.totalPaid)}`);
            addLog(`ุงููุจุงูุบ ุงููุณุฏุฏุฉ - ุญุณุงุจ ูุฏูู: ${formatCurrency(manualPaid)}`);
            addLog(`ุงููุทุงุจูุฉ: ${stats.totalPaid === manualPaid ? 'โ' : 'โ'}`);
            addLog('');
            addLog(`ุงููุจุงูุบ ุงููุชุจููุฉ - ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${formatCurrency(stats.totalPending)}`);
            addLog(`ุงููุจุงูุบ ุงููุชุจููุฉ - ุญุณุงุจ ูุฏูู: ${formatCurrency(manualRemaining)}`);
            addLog(`ุงููุทุงุจูุฉ: ${stats.totalPending === manualRemaining ? 'โ' : 'โ'}`);
            
            if (stats.totalFees === manualTotal && stats.totalPaid === manualPaid && stats.totalPending === manualRemaining) {
                addLog('๐ ุฌููุน ุงูุญุณุงุจุงุช ุตุญูุญุฉ ููุชุทุงุจูุฉ!');
            } else {
                addLog('โ๏ธ ููุงู ุชุถุงุฑุจ ูู ุงูุญุณุงุจุงุช');
            }
            
            addLog('==========================================');
        }
        
        function addLog(message) {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            resultsDiv.textContent += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // ุงุฎุชุจุงุฑ ุชููุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('๐งฎ ูุฑุญุจุงู ุจู ูู ุงุฎุชุจุงุฑ ุญุณุงุจุงุช ุงูููุฎุต ูุงูุฌุฏุงูู');
            addLog('๐ ุณูุชู ุงุฎุชุจุงุฑ ุฌููุน ุงูุญุณุงุจุงุช ูุงูุชุญุฏูุซุงุช');
            addLog('==========================================');
        });
    </script>
</body>
</html>
