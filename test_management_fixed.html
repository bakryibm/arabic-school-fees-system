<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุงุฑ ุฅุตูุงุญุงุช ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div style="padding: 20px;">
        <h1>ุงุฎุชุจุงุฑ ุฅุตูุงุญุงุช ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ</h1>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>1. ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ</h2>
            <button class="btn btn-primary" onclick="setupTestData()">ุฅุนุฏุงุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ</button>
            <button class="btn btn-success" onclick="openManagementScreen()">ูุชุญ ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>2. ุงุฎุชุจุงุฑ ุงูุฏูุน ูุงูุชุญุฏูุซ</h2>
            <button class="btn btn-warning" onclick="simulatePayment()">ูุญุงูุงุฉ ุฏูุน ูุณุท</button>
            <button class="btn btn-info" onclick="checkButtonChange()">ูุญุต ุชุบููุฑ ุงูุฃุฒุฑุงุฑ</button>
            <button class="btn btn-secondary" onclick="checkSummaryUpdate()">ูุญุต ุชุญุฏูุซ ุงูููุฎุต</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>3. ุงุฎุชุจุงุฑ ุณุฌู ุงูุฅุฌุฑุงุกุงุช</h2>
            <button class="btn btn-success" onclick="addTestAction()">ุฅุถุงูุฉ ุฅุฌุฑุงุก ุชุฌุฑูุจู</button>
            <button class="btn btn-info" onclick="viewActionHistory()">ุนุฑุถ ุณุฌู ุงูุฅุฌุฑุงุกุงุช</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>4. ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ</h2>
            <div id="test-results" style="min-height: 300px; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                ุงููุฑ ุนูู "ุฅุนุฏุงุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ" ูุจุฏุก ุงูุงุฎุชุจุงุฑ...
            </div>
        </div>
        
        <!-- ุงูููุงูุฐ ุงูููุจุซูุฉ -->
        <div id="alert-overlay" class="alert-overlay">
            <div class="alert-box">
                <div class="alert-icon">
                    <i id="alert-icon" class="fas fa-info-circle"></i>
                </div>
                <div class="alert-content">
                    <p id="alert-message"></p>
                </div>
                <div class="alert-actions">
                    <button class="btn btn-primary" onclick="closeAlert()">ุญุณูุงู</button>
                </div>
            </div>
        </div>
        
        <div id="manage-student-modal" class="modal">
            <div class="modal-content large-modal">
                <span class="close" onclick="closeModal('manage-student-modal')">&times;</span>
                <div class="modal-header">
                    <h2>ุฅุฏุงุฑุฉ ุงูุทุงูุจ</h2>
                    <div class="student-info-summary">
                        <div class="info-card">
                            <i class="fas fa-user"></i>
                            <span id="manage-student-name">ุฃุญูุฏ ูุญูุฏ</span>
                        </div>
                        <div class="info-card">
                            <i class="fas fa-graduation-cap"></i>
                            <span id="manage-student-grade">ุงูุตู ุงูุฎุงูุณ</span>
                        </div>
                        <div class="info-card">
                            <i class="fas fa-money-bill"></i>
                            <span id="manage-total-fees">500.000 ุฑ.ุน</span>
                        </div>
                    </div>
                </div>
                
                <div class="manage-tabs">
                    <button class="tab-btn active" onclick="showManageTab('payments', this)">ุงูุฃูุณุงุท ูุงููุฏููุนุงุช</button>
                    <button class="tab-btn" onclick="showManageTab('history', this)">ุชุงุฑูุฎ ุงูุฅุฌุฑุงุกุงุช</button>
                    <button class="tab-btn" onclick="showManageTab('summary', this)">ููุฎุต ุงูุญุณุงุจ</button>
                </div>
                
                <div id="payments-tab" class="tab-content active">
                    <div class="payments-section">
                        <h3>ุงูุฃูุณุงุท ุงููุณุชุญูุฉ</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ุฑูู ุงููุณุท</th>
                                        <th>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                                        <th>ุงููุจูุบ</th>
                                        <th>ุงูุญุงูุฉ</th>
                                        <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="installments-tbody">
                                    <!-- ุณูุชู ููุคูุง ุจุงูุจูุงูุงุช -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="history-tab" class="tab-content">
                    <div class="history-section">
                        <h3>ุณุฌู ุงูุนูููุงุช</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ุงูุชุงุฑูุฎ</th>
                                        <th>ููุน ุงูุฅุฌุฑุงุก</th>
                                        <th>ุงูุชูุงุตูู</th>
                                        <th>ุงููุณุชุฎุฏู</th>
                                    </tr>
                                </thead>
                                <tbody id="history-tbody">
                                    <!-- ุณูุชู ููุคูุง ุจุงูุจูุงูุงุช -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="summary-tab" class="tab-content">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="card-content">
                                <h4>ุฅุฌูุงูู ุงูุฑุณูู</h4>
                                <span id="summary-total-fees" class="amount">500.000 ุฑ.ุน</span>
                            </div>
                        </div>
                        
                        <div class="summary-card paid">
                            <div class="card-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="card-content">
                                <h4>ุงููุจูุบ ุงููุณุฏุฏ</h4>
                                <span id="summary-paid-amount" class="amount">0.000 ุฑ.ุน</span>
                            </div>
                        </div>
                        
                        <div class="summary-card pending">
                            <div class="card-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="card-content">
                                <h4>ุงููุจูุบ ุงููุชุจูู</h4>
                                <span id="summary-remaining-amount" class="amount">500.000 ุฑ.ุน</span>
                            </div>
                        </div>
                        
                        <div class="summary-card overdue">
                            <div class="card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="card-content">
                                <h4>ุงููุชุฃุฎุฑุงุช</h4>
                                <span id="summary-overdue-amount" class="amount">0.000 ุฑ.ุน</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-section">
                        <h3>ุชูุฏู ุงูุณุฏุงุฏ</h3>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="payment-progress" class="progress-fill" style="width: 0%; background-color: #e53e3e;"></div>
                            </div>
                            <span id="payment-percentage" class="progress-text">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="database.js"></script>
    <script src="app.js"></script>
    
    <script>
        let testResults = [];
        let testStudentId = null;
        
        function setupTestData() {
            // ุชุณุฌูู ุฏุฎูู ุชููุงุฆู
            const adminUser = {
                id: 1,
                username: 'admin',
                role: 'admin',
                name: 'ูุฏูุฑ ุงููุธุงู'
            };
            localStorage.setItem('logged_in_user', JSON.stringify(adminUser));
            
            // ุฅูุดุงุก ุทุงูุจ ุชุฌุฑูุจู
            const studentData = {
                academic_year: '2024-2025',
                name: 'ุฃุญูุฏ ูุญูุฏ ุนูู',
                grade: 'ุงูุตู ุงูุฎุงูุณ',
                guardian_type: 'ุบูุฑ ููุธู',
                phone: '96891234567',
                current_fees: 500,
                installments_count: 2,
                first_installment_date: '2024-01-01',
                advance_payment: 0,
                payment_method: 'ููุฏุงู'
            };
            
            const result = db.addStudent(studentData);
            if (result.success) {
                testStudentId = result.student.id;
                addTestResult('โ ุชู ุฅูุดุงุก ุทุงูุจ ุชุฌุฑูุจู ุจูุฌุงุญ (ID: ' + testStudentId + ')', 'success');
                addTestResult('โ ุชู ุชุณุฌูู ุงูุฏุฎูู ููุฏูุฑ ุงููุธุงู', 'success');
            } else {
                addTestResult('โ ูุดู ูู ุฅูุดุงุก ุงูุทุงูุจ ุงูุชุฌุฑูุจู', 'error');
            }
        }
        
        function openManagementScreen() {
            if (!testStudentId) {
                addTestResult('โ ูุฌุจ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู', 'error');
                return;
            }
            
            try {
                // ูุชุญ ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ
                manageStudent(testStudentId);
                addTestResult('โ ุชู ูุชุญ ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ', 'success');
                
                // ูุญุต ุชุญุฏูุซ ุงููุนูููุงุช ูู ุงูุฑุฃุณ
                setTimeout(() => {
                    const feesElement = document.getElementById('manage-total-fees');
                    if (feesElement && feesElement.textContent.includes('500')) {
                        addTestResult('โ ุงููุจูุบ ูู ุฑุฃุณ ุงูุดุงุดุฉ ูุธูุฑ ุจุดูู ุตุญูุญ', 'success');
                    } else {
                        addTestResult('โ ุงููุจูุบ ูู ุฑุฃุณ ุงูุดุงุดุฉ ุบูุฑ ุตุญูุญ', 'error');
                    }
                }, 1000);
                
            } catch (error) {
                addTestResult('โ ุฎุทุฃ ูู ูุชุญ ุดุงุดุฉ ุงูุฅุฏุงุฑุฉ: ' + error.message, 'error');
            }
        }
        
        function simulatePayment() {
            if (!testStudentId) {
                addTestResult('โ ูุฌุจ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู', 'error');
                return;
            }
            
            try {
                // ูุญุงูุงุฉ ุฏูุน ูุณุท
                const paymentData = {
                    student_id: testStudentId,
                    amount: 250,
                    payment_method: 'ููุฏุงู',
                    payment_date: new Date().toISOString().split('T')[0],
                    receipt_number: generateReceiptNumber(),
                    notes: 'ุฏูุน ุงููุณุท ุฑูู 1 - ุงุฎุชุจุงุฑ'
                };
                
                const result = db.addPayment(paymentData);
                
                if (result.success) {
                    addTestResult('โ ุชู ุชุณุฌูู ุงูุฏูุนุฉ ุจูุฌุงุญ', 'success');
                    
                    // ุชุญุฏูุซ ุงูุจูุงูุงุช
                    if (typeof updateStudentHeaderInfo === 'function') {
                        updateStudentHeaderInfo(testStudentId);
                        addTestResult('โ ุชู ุชุญุฏูุซ ูุนูููุงุช ุงูุฑุฃุณ', 'success');
                    }
                    
                    if (typeof loadStudentManagementData === 'function') {
                        loadStudentManagementData(testStudentId);
                        addTestResult('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุฅุฏุงุฑุฉ', 'success');
                    }
                    
                    // ูุญุต ุชุญุฏูุซ ุงููุจูุบ ุงููุชุจูู
                    setTimeout(() => {
                        const feesElement = document.getElementById('manage-total-fees');
                        if (feesElement && feesElement.textContent.includes('250')) {
                            addTestResult('โ ุงููุจูุบ ุงููุชุจูู ุชู ุชุญุฏูุซู ุจุดูู ุตุญูุญ', 'success');
                        } else {
                            addTestResult('โ ุงููุจูุบ ุงููุชุจูู ูุฏ ูุง ูููู ูุญุฏุซุงู ุจุดูู ุตุญูุญ', 'warning');
                        }
                    }, 500);
                    
                } else {
                    addTestResult('โ ูุดู ูู ุชุณุฌูู ุงูุฏูุนุฉ: ' + result.error, 'error');
                }
                
            } catch (error) {
                addTestResult('โ ุฎุทุฃ ูู ูุญุงูุงุฉ ุงูุฏูุน: ' + error.message, 'error');
            }
        }
        
        function checkButtonChange() {
            // ูุญุต ุชุบููุฑ ุฃุฒุฑุงุฑ ุงูุฏูุน/ุงูุทุจุงุนุฉ
            const installmentsTable = document.getElementById('installments-tbody');
            if (installmentsTable) {
                const buttons = installmentsTable.querySelectorAll('button');
                let paidButtons = 0;
                let payButtons = 0;
                
                buttons.forEach(button => {
                    if (button.textContent.includes('ุทุจุงุนุฉ')) paidButtons++;
                    if (button.textContent.includes('ุฏูุน')) payButtons++;
                });
                
                addTestResult(`โ ุงูุฃุฒุฑุงุฑ: ${paidButtons} ุทุจุงุนุฉุ ${payButtons} ุฏูุน`, 'info');
                
                if (paidButtons > 0) {
                    addTestResult('โ ููุฌุฏ ุฃุฒุฑุงุฑ ุทุจุงุนุฉ (ุงูุฃูุณุงุท ุงููุฏููุนุฉ)', 'success');
                }
                if (payButtons > 0) {
                    addTestResult('โ ููุฌุฏ ุฃุฒุฑุงุฑ ุฏูุน (ุงูุฃูุณุงุท ุบูุฑ ุงููุฏููุนุฉ)', 'success');
                }
            } else {
                addTestResult('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฌุฏูู ุงูุฃูุณุงุท', 'error');
            }
        }
        
        function checkSummaryUpdate() {
            // ูุญุต ุชุญุฏูุซ ููุฎุต ุงูุญุณุงุจ
            showManageTab('summary');
            
            setTimeout(() => {
                const totalElement = document.getElementById('summary-total-fees');
                const paidElement = document.getElementById('summary-paid-amount');
                const remainingElement = document.getElementById('summary-remaining-amount');
                const progressBar = document.getElementById('payment-progress');
                const progressText = document.getElementById('payment-percentage');
                
                if (totalElement && totalElement.textContent.includes('500')) {
                    addTestResult('โ ุฅุฌูุงูู ุงูุฑุณูู ูู ุงูููุฎุต ุตุญูุญ', 'success');
                } else {
                    addTestResult('โ ุฅุฌูุงูู ุงูุฑุณูู ูู ุงูููุฎุต ุบูุฑ ุตุญูุญ', 'error');
                }
                
                if (paidElement && parseFloat(paidElement.textContent.replace(/[^0-9.]/g, '')) > 0) {
                    addTestResult('โ ุงููุจูุบ ุงููุณุฏุฏ ูู ุงูููุฎุต ูุญุฏุซ', 'success');
                } else {
                    addTestResult('โ ุงููุจูุบ ุงููุณุฏุฏ ูุฏ ูุญุชุงุฌ ุชุญุฏูุซ', 'warning');
                }
                
                if (progressBar && parseInt(progressBar.style.width) > 0) {
                    addTestResult('โ ุดุฑูุท ุงูุชูุฏู ูุนูู (' + progressBar.style.width + ')', 'success');
                } else {
                    addTestResult('โ ุดุฑูุท ุงูุชูุฏู ูุฏ ูุญุชุงุฌ ุชุญุฏูุซ', 'warning');
                }
            }, 500);
        }
        
        function addTestAction() {
            if (!testStudentId) {
                addTestResult('โ ูุฌุจ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู', 'error');
                return;
            }
            
            try {
                logStudentAction(testStudentId, 'ุงุฎุชุจุงุฑ ุงููุธุงู', 'ุฅุฌุฑุงุก ุชุฌุฑูุจู ูุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุนูููุงุช');
                addTestResult('โ ุชู ุชุณุฌูู ุฅุฌุฑุงุก ุชุฌุฑูุจู', 'success');
            } catch (error) {
                addTestResult('โ ุฎุทุฃ ูู ุชุณุฌูู ุงูุฅุฌุฑุงุก: ' + error.message, 'error');
            }
        }
        
        function viewActionHistory() {
            if (!testStudentId) {
                addTestResult('โ ูุฌุจ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู', 'error');
                return;
            }
            
            try {
                showManageTab('history');
                loadStudentActionHistory(testStudentId);
                
                setTimeout(() => {
                    const historyTable = document.getElementById('history-tbody');
                    if (historyTable) {
                        const rows = historyTable.querySelectorAll('tr');
                        if (rows.length > 0) {
                            addTestResult(`โ ุณุฌู ุงูุฅุฌุฑุงุกุงุช ูุนูู (${rows.length} ุฅุฌุฑุงุก)`, 'success');
                        } else {
                            addTestResult('โ ูุง ุชูุฌุฏ ุฅุฌุฑุงุกุงุช ูุณุฌูุฉ', 'warning');
                        }
                    } else {
                        addTestResult('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฌุฏูู ุงูุฅุฌุฑุงุกุงุช', 'error');
                    }
                }, 500);
                
            } catch (error) {
                addTestResult('โ ุฎุทุฃ ูู ุนุฑุถ ุณุฌู ุงูุฅุฌุฑุงุกุงุช: ' + error.message, 'error');
            }
        }
        
        function addTestResult(message, type) {
            const colors = {
                success: 'green',
                error: 'red',
                warning: 'orange',
                info: 'blue'
            };
            
            const icon = {
                success: 'โ',
                error: 'โ',
                warning: 'โ',
                info: 'โน'
            };
            
            const color = colors[type] || 'black';
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            
            testResults.push(`<div style="color: ${color}; margin: 5px 0; padding: 5px; border-left: 3px solid ${color}; background: rgba(${type === 'success' ? '0,255,0' : type === 'error' ? '255,0,0' : type === 'warning' ? '255,165,0' : '0,0,255'}, 0.1);">[${timestamp}] ${icon[type] || ''} ${message}</div>`);
            document.getElementById('test-results').innerHTML = testResults.join('');
            
            // ุงูุชูุฑูุฑ ูุฃุณูู
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // ุงุฎุชุจุงุฑ ุชููุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('๐ ูุฑุญุจุงู ุจู ูู ุงุฎุชุจุงุฑ ุฅุตูุงุญุงุช ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุทุงูุจ', 'info');
            addTestResult('๐ ุงุจุฏุฃ ุจุงูููุฑ ุนูู "ุฅุนุฏุงุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ"', 'info');
        });
    </script>
</body>
</html>
