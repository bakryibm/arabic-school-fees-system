<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุงุฑ ุญุฐู ุงููุฏููุนุงุช</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div style="padding: 20px;">
        <h1>ุงุฎุชุจุงุฑ ูุดููุฉ ุญุฐู ุงููุฏููุนุงุช</h1>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>1. ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ</h2>
            <button class="btn btn-primary" onclick="setupTestData()">ุฅุนุฏุงุฏ ุงูุจูุงูุงุช</button>
            <button class="btn btn-success" onclick="createTestPayments()">ุฅูุดุงุก ูุฏููุนุงุช ุชุฌุฑูุจูุฉ</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>2. ูุญุต ุงููุฏููุนุงุช</h2>
            <button class="btn btn-info" onclick="listPayments()">ุนุฑุถ ุฌููุน ุงููุฏููุนุงุช</button>
            <button class="btn btn-warning" onclick="testDeletePayment()">ุงุฎุชุจุงุฑ ุญุฐู ูุฏููุนุฉ</button>
        </div>
        
        <div class="test-section" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            <h2>3. ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ</h2>
            <div id="test-results" style="min-height: 400px; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; overflow-y: auto;">
                ุงููุฑ ุนูู "ุฅุนุฏุงุฏ ุงูุจูุงูุงุช" ูุจุฏุก ุงูุงุฎุชุจุงุฑ...
            </div>
        </div>
        
        <!-- ุงูููุงูุฐ ุงูููุจุซูุฉ -->
        <div id="alert-overlay" class="alert-overlay">
            <div class="alert-box">
                <div class="alert-icon">
                    <i id="alert-icon" class="fas fa-info-circle"></i>
                </div>
                <div class="alert-content">
                    <p id="alert-message"></p>
                </div>
                <div class="alert-actions">
                    <button class="btn btn-primary" onclick="closeAlert()">ุญุณูุงู</button>
                </div>
            </div>
        </div>
    </div>

    <script src="database.js"></script>
    <script src="app.js"></script>
    
    <script>
        let testStudentId = null;
        let testPayments = [];
        
        function setupTestData() {
            // ุชุณุฌูู ุฏุฎูู ุชููุงุฆู
            const adminUser = {
                id: 1,
                username: 'admin',
                role: 'admin',
                name: 'ูุฏูุฑ ุงููุธุงู'
            };
            localStorage.setItem('logged_in_user', JSON.stringify(adminUser));
            
            // ุฅูุดุงุก ุทุงูุจ ุชุฌุฑูุจู
            const studentData = {
                academic_year: '2024-2025',
                name: 'ุทุงูุจ ุชุฌุฑูุจู ูููุฏููุนุงุช',
                grade: 'ุงูุตู ุงูุฑุงุจุน',
                guardian_type: 'ุบูุฑ ููุธู',
                phone: '96891234567',
                current_fees: 600,
                installments_count: 3,
                first_installment_date: '2024-01-01',
                advance_payment: 0,
                payment_method: 'ููุฏุงู'
            };
            
            const result = db.addStudent(studentData);
            if (result.success) {
                testStudentId = result.student.id;
                addLog('โ ุชู ุฅูุดุงุก ุทุงูุจ ุชุฌุฑูุจู ุจูุฌุงุญ (ID: ' + testStudentId + ')');
                addLog('โ ุชู ุชุณุฌูู ุงูุฏุฎูู ููุฏูุฑ ุงููุธุงู');
                addLog('==========================================');
            } else {
                addLog('โ ูุดู ูู ุฅูุดุงุก ุงูุทุงูุจ ุงูุชุฌุฑูุจู: ' + result.error);
            }
        }
        
        function createTestPayments() {
            if (!testStudentId) {
                addLog('โ ูุฌุจ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู');
                return;
            }
            
            const paymentsToCreate = [
                { amount: 200, notes: 'ุงููุณุท ุงูุฃูู' },
                { amount: 150, notes: 'ุงููุณุท ุงูุซุงูู - ุฌุฒุฆู' },
                { amount: 100, notes: 'ุฏูุนุฉ ุฅุถุงููุฉ' }
            ];
            
            testPayments = [];
            addLog('ุจุฏุก ุฅูุดุงุก ุงููุฏููุนุงุช ุงูุชุฌุฑูุจูุฉ...');
            
            paymentsToCreate.forEach((payment, index) => {
                const paymentData = {
                    student_id: testStudentId,
                    amount: payment.amount,
                    payment_method: 'ููุฏุงู',
                    payment_date: new Date().toISOString().split('T')[0],
                    notes: payment.notes
                };
                
                const result = db.addPayment(paymentData);
                
                if (result.success) {
                    testPayments.push(result.payment);
                    addLog(`โ ุชู ุฅูุดุงุก ุงููุฏููุนุฉ ${index + 1}: ID=${result.payment.id}, ูุจูุบ=${payment.amount}, ุณูุฏ=${result.payment.receipt_number}`);
                } else {
                    addLog(`โ ูุดู ูู ุฅูุดุงุก ุงููุฏููุนุฉ ${index + 1}: ${result.error}`);
                }
            });
            
            addLog('==========================================');
            addLog(`ุชู ุฅูุดุงุก ${testPayments.length} ูุฏููุนุฉ ูู ุฃุตู ${paymentsToCreate.length}`);
        }
        
        function listPayments() {
            if (!testStudentId) {
                addLog('โ ูุฌุจ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู');
                return;
            }
            
            addLog('ุฌุงุฑู ูุญุต ุงููุฏููุนุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');
            
            // ุงูุญุตูู ุนูู ุงููุฏููุนุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            const allPayments = db.getPayments();
            const studentPayments = db.getStudentPayments(testStudentId);
            
            addLog(`ุฅุฌูุงูู ุงููุฏููุนุงุช ูู ุงููุธุงู: ${allPayments.length}`);
            addLog(`ูุฏููุนุงุช ุงูุทุงูุจ ุงูุชุฌุฑูุจู: ${studentPayments.length}`);
            addLog('==========================================');
            
            if (studentPayments.length > 0) {
                addLog('ุชูุงุตูู ูุฏููุนุงุช ุงูุทุงูุจ:');
                studentPayments.forEach((payment, index) => {
                    addLog(`${index + 1}. ID: ${payment.id}, ูุจูุบ: ${payment.amount}, ุณูุฏ: ${payment.receipt_number}, ุชุงุฑูุฎ: ${payment.payment_date}`);
                });
            } else {
                addLog('ูุง ุชูุฌุฏ ูุฏููุนุงุช ููุทุงูุจ ุงูุชุฌุฑูุจู');
            }
            
            addLog('==========================================');
        }
        
        function testDeletePayment() {
            if (!testStudentId) {
                addLog('โ ูุฌุจ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุฃููุงู');
                return;
            }
            
            const studentPayments = db.getStudentPayments(testStudentId);
            
            if (studentPayments.length === 0) {
                addLog('โ ูุง ุชูุฌุฏ ูุฏููุนุงุช ููุญุฐู. ูู ุจุฅูุดุงุก ูุฏููุนุงุช ุชุฌุฑูุจูุฉ ุฃููุงู');
                return;
            }
            
            const firstPayment = studentPayments[0];
            addLog(`ูุญุงููุฉ ุญุฐู ุงููุฏููุนุฉ ุงูุฃููู: ID=${firstPayment.id}, ูุจูุบ=${firstPayment.amount}`);
            
            // ุงุฎุชุจุงุฑ ุญุฐู ุงููุฏููุนุฉ
            const result = db.deletePayment(firstPayment.id);
            
            if (result.success) {
                addLog('โ ุชู ุญุฐู ุงููุฏููุนุฉ ุจูุฌุงุญ!');
                addLog(`ุชูุงุตูู ุงููุฏููุนุฉ ุงููุญุฐููุฉ: ${JSON.stringify(result.deletedPayment, null, 2)}`);
                
                // ูุญุต ุงููุฏููุนุงุช ุจุนุฏ ุงูุญุฐู
                const paymentsAfterDelete = db.getStudentPayments(testStudentId);
                addLog(`ุนุฏุฏ ุงููุฏููุนุงุช ุจุนุฏ ุงูุญุฐู: ${paymentsAfterDelete.length}`);
                
            } else {
                addLog(`โ ูุดู ูู ุญุฐู ุงููุฏููุนุฉ: ${result.error}`);
                
                // ูุนูููุงุช ุฅุถุงููุฉ ููุชุดุฎูุต
                addLog('ูุนูููุงุช ุงูุชุดุฎูุต:');
                addLog(`ููุน ูุนุฑู ุงููุฏููุนุฉ: ${typeof firstPayment.id}`);
                addLog(`ูููุฉ ูุนุฑู ุงููุฏููุนุฉ: ${firstPayment.id}`);
                
                const allPaymentIds = db.getPayments().map(p => ({ id: p.id, type: typeof p.id }));
                addLog(`ุฌููุน ูุนุฑูุงุช ุงููุฏููุนุงุช: ${JSON.stringify(allPaymentIds, null, 2)}`);
            }
            
            addLog('==========================================');
        }
        
        function addLog(message) {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            resultsDiv.textContent += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // ุงุฎุชุจุงุฑ ุชููุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('๐งช ูุฑุญุจุงู ุจู ูู ุงุฎุชุจุงุฑ ุญุฐู ุงููุฏููุนุงุช');
            addLog('๐ ุงุจุฏุฃ ุจุงูููุฑ ุนูู "ุฅุนุฏุงุฏ ุงูุจูุงูุงุช"');
            addLog('==========================================');
        });
    </script>
</body>
</html>
